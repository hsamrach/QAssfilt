Bootstrap: docker
From: ubuntu:22.04

%labels
    Author "hsamrach"
    Version "1.3.6"
    Tool "QAssfilt"

%post
/bin/bash <<'BASHPOST'

set -eux

# ============================
# Install system dependencies
# ============================
apt-get update && apt-get install -y \
    wget git curl ca-certificates bzip2 bash bsdmainutils gawk sed grep \
    findutils coreutils bc parallel util-linux tar gzip build-essential \
    procps unzip vim less locales \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# ============================
# Set locale to prevent Perl warnings
# ============================
locale-gen en_US.UTF-8
update-locale LANG=en_US.UTF-8
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# ============================
# Install miniforge3
# ============================
echo "=== Installing miniforge3 ==="
cd /opt
wget -q https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh
chmod +x Miniforge3-Linux-x86_64.sh

bash Miniforge3-Linux-x86_64.sh -b -p /opt/miniforge3

rm Miniforge3-Linux-x86_64.sh

echo "=== Initializing conda environment ==="
. /opt/miniforge3/etc/profile.d/conda.sh

echo "=== Updating conda and mamba (conda-forge only) ==="
conda update -n base -c conda-forge -y conda mamba

# ============================
# Install QAssfilt and sub-environments
# ============================
echo "=== Installing QAssfilt ==="
mamba install -n base -c samrachhan11 -y qassfilt=1.3.6

# Sub-environments for tools
mamba create -n qassfilt_abricate -y
mamba install -n qassfilt_abricate -c defaults -c bioconda -c conda-forge -y abricate=1.0.1

mamba create -n qassfilt_abritamr -y
mamba install -n qassfilt_abritamr -c defaults -c conda-forge -c bioconda -y abritamr=1.0.20

mamba create -n qassfilt_gtdbtk -y
mamba install -n qassfilt_gtdbtk -c defaults -c conda-forge -c bioconda -y gtdbtk=2.5.2 python=3.11

mamba create -n qassfilt_kraken2 -y
mamba install -n qassfilt_kraken2 -c defaults -c conda-forge -c bioconda -y kraken2=2.1.6

mamba create -n qassfilt_checkm2 python=3.12 -y
mamba install -n qassfilt_checkm2 -c defaults -c conda-forge -c bioconda -y checkm2=1.1.0

mamba create -n qassfilt_fastp python=3.12 -y
mamba install -n qassfilt_fastp -c defaults -c conda-forge -c bioconda -y fastp=1.0.1

mamba create -n qassfilt_spades python=3.12 -y
mamba install -n qassfilt_spades -c defaults -c conda-forge -c bioconda -y spades=4.2.0

mamba create -n qassfilt_quast python=3.12 -y
mamba install -n qassfilt_quast -c defaults -c conda-forge -c bioconda -y quast=5.3.0

mamba create -n qassfilt_seqkit python=3.12 -y
mamba install -n qassfilt_seqkit -c defaults -c conda-forge -c bioconda -y seqkit=2.10.1

mamba create -n qassfilt_multiqc python=3.12 -y
mamba install -n qassfilt_multiqc -c defaults -c conda-forge -c bioconda -y multiqc=1.31

# Clean conda caches
conda clean -afy

# ============================
# Create working directory
# ============================
mkdir -p /home/qassfilt/workdir
chmod 777 -R /home/qassfilt/workdir

BASHPOST

# ============================
# Environment variables
# ============================
%environment
export PATH="/opt/miniforge3/bin:$PATH"
export CONDA_HOME=/opt/miniforge3
export QAssfilt_WD=/home/qassfilt/workdir

# Prevent host Conda contamination
unset CONDA_EXE
unset CONDA_PREFIX
unset CONDA_PYTHON_EXE
unset _CE_M
unset _CE_CONDA
unset CONDA_SHLVL
unset CONDA_PROMPT_MODIFIER

# Set locale
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# Load Conda only in interactive shells to avoid 'local' errors
if [[ $- == *i* ]] && [ -f /opt/miniforge3/etc/profile.d/conda.sh ]; then
    . /opt/miniforge3/etc/profile.d/conda.sh
    eval "$(conda shell.bash hook)"
fi

# ============================
# Run script
# ============================
%runscript
#!/bin/bash
set -eo pipefail

# Load Conda
source /opt/miniforge3/etc/profile.d/conda.sh
eval "$(conda shell.bash hook)"

# Activate base environment
conda activate base

# Force lock files to a real filesystem
export TMPDIR=/tmp
export TEMP=/tmp
export TMP=/tmp

cleanup() {
    kill 0 2>/dev/null || true
}
trap cleanup EXIT

# Run QAssfilt
exec qassfilt "$@"

# ============================
# Help section
# ============================
%help
    This container contains QAssfilt with Conda environment handling.
    Usage:
        apptainer run --bind /srv:/srv /path/qassfilt.sif --help
        apptainer run --bind /srv:/srv /path/qassfilt.sif -i /path/input -o /path/output
